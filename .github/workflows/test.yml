name: Update Readme and Dispatch

on:
  workflow_dispatch:
  push:
    paths:
      - 'readme/**'
      - 'readme/generate-readme-table-of-contents.md'
  repository_dispatch:
    types: [file-changed]

env:
  REPOSITORY_MAPPING: >-
    {
    "readme/windows-install-wsl.md": "brettjrea/Windows_WSL_Debian",
    "readme/debian-bullseye-upgrade-script.md": "brettjrea/Debian_Bullseye_Upgrade_Script",
    "readme/ubuntu-jammy-upgrade-script.md": "brettjrea/Ubuntu_Jammy_Upgrade_Script",
    "readme/debian-install-nvm.md": "brettjrea/Debian_Install_NVM",
    "readme/debian-install-nvs.md": "brettjrea/Debian_Install_NVS",
    "readme/debian-install-common-build-tools.md": "brettjrea/Debian_Install_Common_Build_Tools",
    "readme/debian-strapi-backend-api.md": "brettjrea/Debian_Strapi_Backend_API",
    "readme/debian-gatsby-frontend-client.md": "brettjrea/Debian_Gatsby_Frontend_Client",
    "readme/gatsby-typescript-styled-components.md": "brettjrea/Gatsby_Typescript_Styled_Components",
    "readme/debian-configure-pm2.md": "brettjrea/Debian_Configure_PM2",
    "readme/debian-install-github-cli.md": "brettjrea/Debian_Install_GitHub_CLI"
    }

jobs:
  dispatch-file-changed:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'repository_dispatch' }}
    steps:
      - name: Extract repository name
        id: extract-repo
        run: |
          REPO=$(echo "${{ github.event.client_payload.repository }}" | tr -d '\n')
          echo "::set-output name=repository::$REPO"

      - name: Run a step if a file was modified
        if: ${{ github.event.client_payload.message == "A file was modified" }}
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: ${{ steps.extract-repo.outputs.repository }}
          event-type: file-changed
          client-payload: '{ "message": "A file was modified" }'

  update-readme:
    runs-on: ubuntu-latest
    needs: [dispatch-file-changed]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v35

      - name: Extract file name
        id: extract-file
        run: |
          MODIFIED_FILES=$(echo "${{ steps.changed-files.outputs.modified_files }}" | tr -d '\n')
          FILENAME=$(echo "$MODIFIED_FILES" | head -n1)
          echo "::set-output name=filename::$FILENAME"

      - name: Extract repository name
        id: extract-repo
        if: steps.extract-file.outputs.filename != 'readme/generate-readme-table-of-        contents.md' && steps.extract-file.outputs.filename != 'readme/github-generate-readme.md'
        run: |
          FILENAME="${{ steps.extract-file.outputs.filename }}"
          REPO=$(echo "$REPOSITORY_MAPPING" | jq -r '."'"$FILENAME"'"')
          echo "::set-output name=repository::$REPO"

      - name: Combine files and commit if specified files were modified
        if: "contains(steps.changed-files.outputs.modified_files, 'readme/generate-readme-table-of-contents.md') || contains(steps.changed-files.outputs.modified_files, 'readme/github-generate-readme.md') || github.event_name == 'repository_dispatch'"
        run: |
          toc=$(cat readme/generate-readme-table-of-contents.md)
          config=$(cat readme/github-generate-readme.md)
          readme="$(echo -e "${toc}\n---\n${config}")"
          echo "${readme}" > README.md

      - name: Auto commit
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Auto commit updated README.md'
          file_pattern: 'README.md'

  dispatch-readme-toc:
    runs-on: ubuntu-latest
    if: ${{ github.event.client_payload.message == "generate-readme-table-of-contents.md changed" }}
    strategy:
          matrix:
            repository:
              - brettjrea/Windows_WSL_Debian
              - brettjrea/Debian_Bullseye_Upgrade_Script
              - brettjrea/Ubuntu_Jammy_Upgrade_Script
              - brettjrea/Debian_Install_NVM
              - brettjrea/Debian_Install_NVS
              - brettjrea/Debian_Install_Common_Build_Tools
              - brettjrea/Debian_Strapi_Backend_API
              - brettjrea/Debian_Gatsby_Frontend_Client
              - brettjrea/Gatsby_Typescript_Styled_Components
              - brettjrea/Debian_Configure_PM2
              - brettjrea/Debian_Install_GitHub_CLI
    steps:
      - name: Use Matrix to send dispatch to all repositories.
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: ${{ matrix.repository }}
          event-type: file-changed
          client-payload: '{ "message": "generate-readme-table-of-contents.md changed" }'
        

